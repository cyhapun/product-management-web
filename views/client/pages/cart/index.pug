extends ../../layouts/default.pug

block main
  // Bootstrap Icons
  link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css")
  // SweetAlert2 CDN
  script(src="https://cdn.jsdelivr.net/npm/sweetalert2@11")

  style.
    body {
      background: #f8f9fa;
    }
    .cart-page h1 {
      font-weight: 700;
    }
    .cart-item-card {
      transition: all 0.2s ease-in-out;
    }
    .cart-item-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    .price-text {
      color: #dc3545;
      font-weight: 600;
    }
    /* Scroll riêng cho danh sách */
    .cart-items-scroll {
      max-height: 500px; /* Hoặc dùng 70vh nếu muốn responsive hơn */
      overflow-y: auto;
      padding-right: 5px;
    }
    /* Scrollbar đẹp hơn */
    .cart-items-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .cart-items-scroll::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }
    .cart-items-scroll::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

  .cart-page.my-5
    .container
      .mb-4
        button.btn.btn-outline-secondary(type="button", onclick="goBackFromCart()")
          i.bi.bi-arrow-left.me-1.mr-1
          | Back
      h1.mb-5.text-center.text-primary
        i.bi.bi-cart4.me-2.mr-2
        | Your Shopping Cart

      if cart.products.length > 0
        .row.g-4
          //- Cột danh sách sản phẩm
          .col-lg-8
            .cart-items-scroll
              each item, index in cart.products
                .card.cart-item-card.mb-3.shadow-sm.border-0.rounded-3
                  .card-body.d-flex.align-items-center.gap-3
                    // Hình ảnh sản phẩm
                    img(
                      src=item.productInfo.thumbnail,
                      alt=item.productInfo.title,
                      class="rounded mr-2",
                      style="width: 100px; height: 100px; object-fit: cover;"
                    )

                    // Thông tin sản phẩm
                    .flex-grow-1
                      h5.mb-1
                        a(
                          href=`/products/detail/${item.productInfo.slug}`,
                          class="text-dark text-decoration-none"
                        ) #{item.productInfo.title}
                      
                      small.text-muted Unit Price: 
                        span.price-text.ms-1 #{item.productInfo.price.toLocaleString()}$
                      br
                      small.text-muted Total: 
                        span.total-price.price-text.ms-1 #{item.totalPrice.toLocaleString()}$
                      
                      // Điều khiển số lượng
                      .d-flex.align-items-center.mt-2
                        button.btn.btn-sm.btn-outline-secondary(
                          type="button",
                          onclick="updateQuantity(this,-1)"
                        )
                          i.bi.bi-dash
                        
                        input(
                          type="number"
                          class="form-control form-control-sm text-center mx-1 quantity-input"
                          name=`products[${index}][quantity]`
                          value=item.quantity
                          min="1"
                          data-stock=item.productInfo.stock
                          style="width:60px"
                          onchange="updateRowTotal(this)"
                        )
                        input(
                          type="hidden",
                          name=`products[${index}][id]`,
                          value=item.productId
                        )
                        
                        button.btn.btn-sm.btn-outline-secondary(
                          type="button",
                          onclick="updateQuantity(this,1)"
                        )
                          i.bi.bi-plus
                    
                    // Nút xóa
                    a(
                      href=`/cart/delete/${item.productId}`,
                      class="btn btn-outline-danger btn-sm ms-auto"
                    )
                      i.bi.bi-trash

            // Nút cập nhật giỏ hàng
            .text-end.mt-4
              form(action="/cart/update", method="POST")
                button(type="submit", class="btn btn-info px-4 py-2")
                  i.bi.bi-arrow-repeat.me-2
                  | Update Cart

          //- Cột Order Summary
          .col-lg-4
            .card.shadow-sm.border-0.rounded-3
              .card-body
                h4.mb-4.text-center
                  i.bi.bi-receipt-cutoff.me-2.mr-1
                  | Order Summary
                hr
                .d-flex.justify-content-between.mb-3
                  span.fw-bold Total:
                  span#cart-subtotal.fw-bold.text-danger #{cart.totalPrice.toLocaleString()}$
                
                p.text-muted.small.text-center Shipping fees will be calculated at checkout.
                
                a(href="/checkout", class="btn btn-success w-100 mt-3 py-2")
                  i.bi.bi-wallet-fill.me-2.mr-2
                  | Checkout

      else
        .row.justify-content-center
          .col-md-6.text-center
            .p-5.bg-white.border.rounded.shadow-sm
              i.bi.bi-cart-x.display-1.text-muted
              h3.mt-3 Your cart is empty
              p.text-muted Start shopping to fill up your cart!

  //- JS xử lý cập nhật giỏ hàng + kiểm tra stock
  script.
    function showStockWarning(stock) {
    Swal.fire({
        icon: 'warning',
        title: 'Stock limit reached',
        text: `Only ${stock} items available in stock.`,
        confirmButtonColor: '#3085d6',
    });
    }

    function updateQuantity(button, change) {
    const input = button.parentElement.querySelector('.quantity-input');
    let currentValue = parseInt(input.value);
    const stock = parseInt(input.dataset.stock);

    let newValue = currentValue + change;
    if (newValue < 1) newValue = 1;

    if (!isNaN(stock) && newValue > stock) {
        showStockWarning(stock);
        newValue = stock;
    }

    input.value = newValue;
    updateRowTotal(input);
    }

    function updateRowTotal(input) {
    const stock = parseInt(input.dataset.stock);
    let quantity = parseInt(input.value);

    if (!isNaN(stock) && quantity > stock) {
        showStockWarning(stock);
        quantity = stock;
        input.value = stock;
    }
    if (quantity < 1 || isNaN(quantity)) {
        quantity = 1;
        input.value = 1;
    }

    const card = input.closest('.card');
    const priceElement = card.querySelector('.price-text');
    const totalPriceElement = card.querySelector('.total-price');

    const price = parseFloat(priceElement.innerText.replace(/[^0-9.-]+/g,""));
    const total = price * quantity;

    totalPriceElement.innerText = total.toLocaleString() + '$';
    updateCartTotal();
    }

    function updateCartTotal() {
    const allTotals = document.querySelectorAll('.total-price');
    let subtotal = 0;
    allTotals.forEach(el => {
        const val = parseFloat(el.innerText.replace(/[^0-9.-]+/g,""));
        subtotal += val;
    });
    document.getElementById('cart-subtotal').innerText = subtotal.toLocaleString() + '$';
    }
